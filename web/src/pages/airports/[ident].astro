---
import Layout from '../../layouts/Layout.astro';
import Map from '../../components/Map.astro';
import { AirportDatabase } from '../../lib/database';

// Get airport identifier from URL params
const { ident } = Astro.params;

if (!ident) {
  return Astro.redirect('/');
}

// Get database from Astro locals
const db = (Astro.locals as any).runtime?.env?.DB || (Astro.locals as any).DB;

if (!db) {
  throw new Error('Database not available');
}

// Create database instance and get airport data
const airportDb = new AirportDatabase(db);
const key = decodeURIComponent(ident as string);
let airportData = await airportDb.getAirportByCode(key);
if (!airportData) {
  const search = await airportDb.searchAirports({ query: key, limit: 1 });
  airportData = search.airports[0];
}

if (!airportData) {
  return Astro.redirect('/');
}

const destinationsList = airportData.destinationsData && airportData.destinationsData.direct_flights ? airportData.destinationsData.direct_flights.slice() : [];
const destinations = destinationsList.map((d: any) => ({
  city: d.city,
  airports: (d.airports || []).filter((a: any) => a.icao || a.iata || a.name)
}));
destinations.sort((a: any, b: any) => a.city.localeCompare(b.city));
for (const d of destinations) { d.airports.sort((a: any, b: any) => (a.name || '').localeCompare(b.name || '')); }
const totalCities = destinations.length;
const totalAirports = destinations.reduce((sum: number, d: any) => sum + d.airports.length, 0);

// Get Wikipedia information if available
let wikipediaInfo = null;
if (airportData.wikipedia_link) {
  try {
    const match = airportData.wikipedia_link.match(/\/wiki\/([^#?]+)/);
    if (match) {
      const pageTitle = decodeURIComponent(match[1]);
      const langMatch = airportData.wikipedia_link.match(/\/\/(\w+)\.wikipedia\.org/);
      const language = langMatch ? langMatch[1] : 'en';

      const apiUrl = `https://${language}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(pageTitle)}`;

      const response = await fetch(apiUrl, {
        headers: {
          'User-Agent': 'AyaMap-Airports/1.0 (https://airport.ayamap.com)'
        }
      });

      if (response.ok) {
        const data = await response.json();
        wikipediaInfo = {
          title: data.title || pageTitle,
          extract: data.extract || '',
          thumbnail: data.thumbnail?.source || null,
          url: data.content_urls?.desktop?.page || airportData.wikipedia_link,
          language: language
        };
      }
    }
  } catch (error) {
    console.error('Error fetching Wikipedia info:', error);
  }
}

// Prepare keywords
const keywords = airportData.keywords ? airportData.keywords.split(',').map(k => k.trim()).filter(k => k) : [];

const title = `${airportData.name || `${ident.toUpperCase()} Airport`} - Live Flights & Destinations - AyaMap`;
const iataCode = airportData.iata_code ? `(${airportData.iata_code})` : '';
const icaoCode = airportData.icao_code ? `ICAO: ${airportData.icao_code}` : '';
const codes = [iataCode, icaoCode].filter(c => c).join(' | ');
const description = `${airportData.name || ident.toUpperCase()} ${codes} in ${airportData.municipality || 'Unknown City'}, ${airportData.iso_country || 'Unknown Country'}. Check real-time flight departures and arrivals, view live flight status, and explore direct flight destinations from this airport.`;
const canonicalUrl = `https://airport.ayamap.com/airports/${encodeURIComponent(airportData.name || airportData.ident)}`;

// Helper function for type badges
function getTypeBadge(type: string | null) {
  switch (type) {
    case 'large_airport':
      return '<span class="bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Large Airport</span>';
    case 'medium_airport':
      return '<span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Medium Airport</span>';
    case 'small_airport':
      return '<span class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Small Airport</span>';
    case 'heliport':
      return '<span class="bg-purple-100 text-purple-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Heliport</span>';
    case 'seaplane_base':
      return '<span class="bg-cyan-100 text-cyan-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Seaplane Base</span>';
    default:
      return '<span class="bg-gray-100 text-gray-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Other</span>';
  }
}
---

<Layout title={title} description={description}>
	<!-- SEO Meta Tags -->
	<meta name="keywords" content={`${ident} airport, ${ident} live flights, ${ident} departures, ${ident} arrivals, ${ident} direct flights, real-time flight status, airport information`} slot="head" />
	<link rel="canonical" href={canonicalUrl} slot="head" />

	<!-- Open Graph Meta Tags -->
	<meta property="og:title" content={title} slot="head" />
	<meta property="og:description" content={description} slot="head" />
	<meta property="og:url" content={canonicalUrl} slot="head" />
	<meta property="og:type" content="place" slot="head" />

	<script slot="head">
		(function(){
			try{history.scrollRestoration='manual'}catch(_){}
			var h=window.location.hash;
			if(h==='#location'||h==='#map'){
				history.replaceState(null,'',window.location.pathname+window.location.search);
				window.scrollTo(0,0);
			}
		})();
	</script>

	<!-- Structured Data -->
	<script type="application/ld+json" slot="head">
	{
		"@context": "https://schema.org",
		"@type": "Airport",
		"name": airportData.name || `${airportData.ident} Airport`,
		"identifier": airportData.ident,
		"iataCode": airportData.iata_code,
		"icaoCode": airportData.ident,
		"address": {
			"@type": "PostalAddress",
			"addressLocality": airportData.municipality,
			"addressCountry": airportData.iso_country
		},
		"geo": airportData.latitude_deg && airportData.longitude_deg ? {
			"@type": "GeoCoordinates",
			"latitude": airportData.latitude_deg,
			"longitude": airportData.longitude_deg
		} : undefined,
		"elevation": airportData.elevation_ft ? `${airportData.elevation_ft} ft` : undefined,
		"url": `https://airport.ayamap.com/airports/${airportData.ident}`
	}
	</script>

	<main class="min-h-screen bg-gray-50">
		<!-- Hero Section -->
		<div class="bg-gradient-to-b from-primary-900 to-primary-800 text-white pb-32">
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
				<nav class="flex items-center space-x-2 text-sm text-primary-200 mb-8">
					<a href="/" class="hover:text-white transition-colors">Home</a>
					<span>/</span>
					<a href="/airports" class="hover:text-white transition-colors">Airports</a>
					<span>/</span>
					{airportData.iso_country && (
						<>
							<a href={`/airports?country=${airportData.iso_country}`} class="hover:text-white transition-colors">{airportData.iso_country.toUpperCase()}</a>
							<span>/</span>
						</>
					)}
					<span class="text-white font-medium">{airportData.ident}</span>
				</nav>
				
				<div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
					<div>
						<div class="flex items-center gap-4 mb-4">
							<div set:html={getTypeBadge(airportData.type)}></div>
							{airportData.iata_code && (
								<span class="px-3 py-1 bg-white/10 backdrop-blur-sm rounded-full text-xs font-bold uppercase tracking-wide border border-white/20">
									IATA: {airportData.iata_code}
								</span>
							)}
							<span class="px-3 py-1 bg-white/10 backdrop-blur-sm rounded-full text-xs font-bold uppercase tracking-wide border border-white/20">
								ICAO: {airportData.ident}
							</span>
						</div>
						<h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-4 tracking-tight">
							{airportData.name || `${airportData.ident} Airport`}
						</h1>
						<div class="flex items-center gap-2 text-primary-100 text-lg">
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
							</svg>
							<span>
								{airportData.municipality || 'Unknown City'}, {airportData.iso_country || 'Unknown Country'}
							</span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Content Section -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-24 pb-12">
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
				<!-- Left Column (Main Info) -->
				<div class="lg:col-span-2 space-y-8">
					<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-6 lg:mb-12 xl:mb-16">
						<nav class="flex flex-wrap items-left justify-left gap-2 sm:gap-3 text-xs sm:text-sm">
							<a href="#about" class="px-2 py-1 sm:px-3 rounded-full bg-gray-50 hover:bg-primary-50 text-gray-700 hover:text-primary-700 border border-gray-200 text-xs sm:text-sm whitespace-nowrap">About</a>
							<a href="#basic" class="px-2 py-1 sm:px-3 rounded-full bg-gray-50 hover:bg-primary-50 text-gray-700 hover:text-primary-700 border border-gray-200 text-xs sm:text-sm whitespace-nowrap">Basic</a>
							<a href="#location" class="px-2 py-1 sm:px-3 rounded-full bg-gray-50 hover:bg-primary-50 text-gray-700 hover:text-primary-700 border border-gray-200 text-xs sm:text-sm whitespace-nowrap">Location</a>
							<a href="#flight" class="px-2 py-1 sm:px-3 rounded-full bg-gray-50 hover:bg-primary-50 text-gray-700 hover:text-primary-700 border border-gray-200 text-xs sm:text-sm whitespace-nowrap">Flight Information</a>
							<a href="#destinations" class="px-2 py-1 sm:px-3 rounded-full bg-gray-50 hover:bg-primary-50 text-gray-700 hover:text-primary-700 border border-gray-200 text-xs sm:text-sm whitespace-nowrap">Direct Destinations</a>
						</nav>
					</div>
					
					<!-- Wikipedia Information -->
					{wikipediaInfo && (
						<div id="about" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 mt-8 lg:mt-24 xl:mt-28 scroll-mt-24 md:scroll-mt-28 lg:scroll-mt-36">
							<h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
								<span class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-600">
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
									</svg>
								</span>
								About This Airport
							</h2>
							<div class="flex flex-col md:flex-row gap-6">
								<div class="flex-1">
									<h3 class="text-xl font-bold text-gray-900 mb-3">{wikipediaInfo.title}</h3>
									<p class="text-gray-600 leading-relaxed mb-4">{wikipediaInfo.extract}</p>
									<a
										href={wikipediaInfo.url}
										target="_blank"
										rel="noopener noreferrer"
										class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium transition-colors group"
									>
										Read full article on Wikipedia
										<svg class="ml-1 w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
										</svg>
									</a>
								</div>
								{wikipediaInfo.thumbnail && (
									<div class="flex-shrink-0 w-full md:w-64">
										<img
											src={wikipediaInfo.thumbnail}
											alt={wikipediaInfo.title}
											class="w-full h-48 md:h-auto object-cover rounded-xl shadow-md"
											loading="lazy"
										/>
									</div>
								)}
							</div>
						</div>
					)}

					<!-- Basic Info Card -->
					<div id="basic" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 scroll-mt-24 md:scroll-mt-28 lg:scroll-mt-36">
						<h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
							<span class="w-8 h-8 rounded-lg bg-primary-50 flex items-center justify-center text-primary-600">
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
								</svg>
							</span>
							Basic Information
						</h2>
						<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
							<div class="bg-gray-50 rounded-xl p-4">
								<label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">ICAO Code</label>
								<p class="text-xl font-semibold text-gray-900">{airportData.ident || '-'}</p>
							</div>
							<div class="bg-gray-50 rounded-xl p-4">
								<label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">IATA Code</label>
								<p class="text-xl font-semibold text-gray-900">{airportData.iata_code || '-'}</p>
							</div>
							<div class="bg-gray-50 rounded-xl p-4">
								<label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Country</label>
								<p class="text-lg font-medium text-gray-900">{airportData.iso_country || '-'}</p>
							</div>
							<div class="bg-gray-50 rounded-xl p-4">
								<label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Region</label>
								<p class="text-lg font-medium text-gray-900">{airportData.iso_region || '-'}</p>
							</div>
							<div class="bg-gray-50 rounded-xl p-4">
								<label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Municipality</label>
								<p class="text-lg font-medium text-gray-900">{airportData.municipality || '-'}</p>
							</div>
							<div class="bg-gray-50 rounded-xl p-4">
								<label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Elevation</label>
								<p class="text-lg font-medium text-gray-900">{airportData.elevation_ft ? `${airportData.elevation_ft} ft` : '-'}</p>
							</div>
						</div>
					</div>

					<!-- Location Card -->
					<div id="location" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 scroll-mt-24 md:scroll-mt-28 lg:scroll-mt-36">
						<h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
							<span class="w-8 h-8 rounded-lg bg-green-50 flex items-center justify-center text-green-600">
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
								</svg>
							</span>
							Location
						</h2>
						<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
							<div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
								<span class="text-sm text-gray-500 font-medium">Latitude</span>
								<span class="text-lg font-mono font-semibold text-gray-900">{airportData.latitude_deg ? airportData.latitude_deg.toFixed(6) : '-'}</span>
							</div>
							<div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
								<span class="text-sm text-gray-500 font-medium">Longitude</span>
								<span class="text-lg font-mono font-semibold text-gray-900">{airportData.longitude_deg ? airportData.longitude_deg.toFixed(6) : '-'}</span>
							</div>
						</div>
						
						{airportData.latitude_deg && airportData.longitude_deg ? (
							<div class="rounded-xl overflow-hidden shadow-inner border border-gray-200">
								<Map
									latitude={airportData.latitude_deg}
									longitude={airportData.longitude_deg}
									name={airportData.name || `${airportData.ident} Airport`}
									ident={airportData.ident}
									municipality={airportData.municipality || undefined}
									iso_country={airportData.iso_country || undefined}
								/>
							</div>
						) : (
							<div class="h-64 rounded-xl overflow-hidden border border-gray-200 flex items-center justify-center bg-gray-50">
								<p class="text-gray-500 font-medium">Location coordinates not available</p>
							</div>
						)}
					</div>

					<!-- Flight Information -->
					{airportData.iata_code && (
						<div id="flight" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 scroll-mt-24 md:scroll-mt-28 lg:scroll-mt-36">
							<h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
								<span class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
									</svg>
								</span>
								Flight Information
							</h2>
							<div class="avionio-widget rounded-xl overflow-hidden border border-gray-200 shadow-inner">
								<iframe height="600px" frameborder="0" style="border:0; width: 100%; margin:0; padding:0;" src={`https://www.avionio.com/widget/en/${airportData.iata_code.toLowerCase()}/departures?style=2`}></iframe>
								<div class="bg-gray-50 py-2 text-center text-xs text-gray-500 border-t border-gray-200">
									<a class="hover:text-primary-600 transition-colors" href={`https://www.avionio.com/en/airport/${airportData.iata_code.toLowerCase()}/departures`} target="_blank">{airportData.iata_code} Departures</a>
									<span class="mx-1">‚Ä¢</span>
									<a class="hover:text-primary-600 transition-colors" href="https://www.avionio.com/" target="_blank">Avionio.com</a>
								</div>
							</div>
						</div>
					)}

			
					<!-- Direct Flight Destinations -->
					{destinations && destinations.length > 0 && (
						<div id="destinations" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8 scroll-mt-24 md:scroll-mt-28 lg:scroll-mt-36">
							<h2 class="text-2xl font-bold text-gray-900 mb-2 flex items-center gap-2">
								<span class="w-8 h-8 rounded-lg bg-purple-50 flex items-center justify-center text-purple-600">
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
									</svg>
								</span>
								Direct Destinations
							</h2>
							<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
								<p class="text-gray-500">
									Direct flights from {airportData.destinationsData.departure_airport.name} ({airportData.destinationsData.departure_airport.iata})
								</p>
						<div class="flex items-center gap-2 sm:gap-3">
							<span id="dest-count" class="text-xs text-gray-500">{totalCities} cities ¬∑ {totalAirports} airports</span>
						</div>
							</div>
						<div id="destinations-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
								{destinations.map((destination) => (
									<div class="destination-card border border-gray-200 rounded-xl p-4 md:p-5 hover:border-primary-300 hover:shadow-md transition-all duration-200 bg-gray-50/50" data-city={destination.city.toLowerCase()} data-airports={(destination.airports || []).map((a) => `${(a.name || '').toLowerCase()} ${(a.iata || '').toLowerCase()} ${(a.icao || '').toLowerCase()}`).join(' ')}>
										<h3 class="font-bold text-gray-900 mb-3 flex items-center gap-2">
											<span class="text-xl">üìç</span>
											<span>{destination.city}</span>
										</h3>
										<div class="space-y-2">
											{destination.airports.map((airport) => (
												<a
													href={`/airports/${airport.icao || airport.iata || encodeURIComponent(airport.name)}`}
												class="block p-2.5 md:p-3 bg-white rounded-lg border border-gray-100 hover:border-primary-200 hover:bg-primary-50 transition-all group"
												>
													<div class="flex items-center justify-between">
														<div class="flex-1 min-w-0">
															<p class="text-sm font-semibold text-gray-900 truncate group-hover:text-primary-700">
																{airport.name}
															</p>
															<p class="text-xs text-gray-500 font-mono mt-0.5">
																{(airport.iata || '').toUpperCase()} {(airport.icao ? `/ ${airport.icao}` : '')}
															</p>
														</div>
														<svg class="w-4 h-4 text-gray-300 group-hover:text-primary-500 flex-shrink-0 ml-2 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
															<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
														</svg>
													</div>
												</a>
											))}
										</div>
									</div>
								))}
							</div>
						</div>
					)}
				</div>

				<!-- Right Column (Sidebar) -->
				<div class="order-last lg:order-none space-y-8">
					<!-- Quick Actions -->
					<div id="quick-actions" class="lg:sticky lg:top-4 z-40 bg-white/95 backdrop-blur-sm rounded-2xl shadow-sm border border-gray-100 p-6">
						<h3 class="text-lg font-bold text-gray-900 mb-4">Quick Actions</h3>
						<div class="space-y-3">
							<button id="copy-coordinates" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-200 text-gray-700 px-4 py-3 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all text-sm font-medium shadow-sm">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
								</svg>
								Copy Coordinates
							</button>
							<a id="google-maps-link" href={`https://www.google.com/maps?q=${airportData.latitude_deg},${airportData.longitude_deg}`} target="_blank" rel="noopener noreferrer" class="w-full flex items-center justify-center gap-2 bg-green-50 text-green-700 px-4 py-3 rounded-xl hover:bg-green-100 transition-colors text-sm font-medium">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 7m0 13V7" />
								</svg>
								Open in Google Maps
							</a>
							{airportData.home_link && (
								<a href={airportData.home_link} target="_blank" rel="noopener noreferrer" class="w-full flex items-center justify-center gap-2 bg-purple-50 text-purple-700 px-4 py-3 rounded-xl hover:bg-purple-100 transition-colors text-sm font-medium">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
									</svg>
									Official Website
								</a>
							)}
						{airportData.wikipedia_link && (
							<a href={airportData.wikipedia_link} target="_blank" rel="noopener noreferrer" class="w-full flex items-center justify-center gap-2 bg-gray-100 text-gray-700 px-4 py-3 rounded-xl hover:bg-gray-200 transition-colors text-sm font-medium">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
								</svg>
								Wikipedia Article
							</a>
						)}
						<button id="qa-back-top" class="hidden w-full flex items-center justify-center gap-2 bg-primary-50 text-primary-700 px-4 py-3 rounded-xl hover:bg-primary-100 transition-colors text-sm font-medium">
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7 7 7M12 3v18" />
							</svg>
							Back to Top
						</button>
					</div>
				</div>

				</div>
			</div>
		</div>
	</main>
</Layout>

<script define:vars={{ airportData, wikipediaInfo }}>
	// Copy coordinates to clipboard
	async function copyCoordinates() {
		if (!airportData || !airportData.latitude_deg || !airportData.longitude_deg) return;

		const coordinates = `${airportData.latitude_deg}, ${airportData.longitude_deg}`;
		try {
			await navigator.clipboard.writeText(coordinates);
			// Show temporary feedback
			const copyBtn = document.getElementById('copy-coordinates');
			const originalContent = copyBtn.innerHTML;
			
			copyBtn.innerHTML = `
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
				</svg>
				Copied!
			`;
			copyBtn.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
			copyBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-200');
			
			setTimeout(() => {
				copyBtn.innerHTML = originalContent;
				copyBtn.classList.remove('bg-green-50', 'text-green-700', 'border-green-200');
				copyBtn.classList.add('bg-white', 'text-gray-700', 'border-gray-200');
			}, 2000);
		} catch (error) {
			console.error('Failed to copy coordinates:', error);
		}
	}

	const copyBtn = document.getElementById('copy-coordinates');
	if (copyBtn) {
		copyBtn.addEventListener('click', copyCoordinates);
	}

	if ('scrollRestoration' in history) {
		// Prevent browser restoring scroll or jumping to anchors on initial navigation
		(history as any).scrollRestoration = 'manual';
	}

	const initialHash = window.location.hash;
	const blockedHashes = new Set(['#location', '#map']);
	if (blockedHashes.has(initialHash)) {
		window.addEventListener('load', () => {
			history.replaceState(null, '', window.location.pathname + window.location.search);
			window.scrollTo({ top: 0, behavior: 'auto' });
		});
		const suppressUntil = Date.now() + 1500;
		window.addEventListener('hashchange', () => {
			if (Date.now() < suppressUntil && blockedHashes.has(window.location.hash)) {
				history.replaceState(null, '', window.location.pathname + window.location.search);
				window.scrollTo({ top: 0, behavior: 'auto' });
			}
		}, { passive: true });
	}

	const filterInputEl = document.getElementById('dest-filter');
	if (filterInputEl && filterInputEl instanceof HTMLInputElement) {
		const cards = Array.from(document.querySelectorAll('.destination-card'));
		const countEl = document.getElementById('dest-count');
		function applyFilter() {
			const q = filterInputEl.value.trim().toLowerCase();
			let visible = 0;
			let airportsVisible = 0;
			for (const card of cards) {
				const city = card.getAttribute('data-city') || '';
				const airports = card.getAttribute('data-airports') || '';
				const match = q === '' || city.includes(q) || airports.includes(q);
				card.classList.toggle('hidden', !match);
				if (match) {
					visible += 1;
					airportsVisible += card.querySelectorAll('a').length;
				}
			}
			if (countEl) countEl.textContent = `${visible} cities ¬∑ ${airportsVisible} airports`;
		}
		filterInputEl.addEventListener('input', applyFilter);
	}

	const qaBackTopBtn = document.getElementById('qa-back-top');
	const qaContainer = document.getElementById('quick-actions');
	if (qaBackTopBtn) {
		function toggleQaBackTop() {
			const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
			let show = false;
			if (isDesktop && qaContainer) {
				const top = qaContainer.getBoundingClientRect().top;
				show = top <= 24;
			} else {
				const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 120;
				show = nearBottom;
			}
			qaBackTopBtn.classList.toggle('hidden', !show);
		}
		window.addEventListener('scroll', toggleQaBackTop, { passive: true });
		qaBackTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
		toggleQaBackTop();
	}
</script>

<style>
	/* Custom scrollbar for widget */
	.avionio-widget iframe {
		display: block;
	}
</style>