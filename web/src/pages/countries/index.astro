---
import Layout from "../../layouts/Layout.astro";
import { AirportDatabase } from "../../lib/database";

const db = (Astro.locals as any).runtime?.env?.DB;
if (!db) {
	throw new Error("Database not available");
}

const airportDb = new AirportDatabase(db);
const countries = await airportDb.getCountryStats();

// Calculate global stats similar to airports page
const stats = {
	total: countries.reduce((sum, country) => sum + country.airport_count, 0),
	large: countries.reduce(
		(sum, country) => sum + (country.large_airport_count || 0),
		0,
	),
	medium: countries.reduce(
		(sum, country) => sum + (country.medium_airport_count || 0),
		0,
	),
	small: countries.reduce(
		(sum, country) => sum + (country.small_airport_count || 0),
		0,
	),
	countries: countries.length,
};

const title =
	"Airports by Country - Live Flights & Direct Destinations - AyaMap";
const description =
	"Browse airports by country and territory. Check real-time flight departures and arrivals, view live flight status, and discover direct flight destinations from airports worldwide.";
const canonicalUrl = "https://airport.ayamap.com/countries/";
---

<Layout title={title} description={description}>
	<!-- SEO Meta Tags -->
	<meta
		name="keywords"
		content="airports by country, live flights, flight departures, flight arrivals, real-time flight status, direct flights, world airports, aviation, international airports"
		slot="head"
	/>
	<link rel="canonical" href={canonicalUrl} slot="head" />

	<!-- Open Graph Meta Tags -->
	<meta property="og:title" content={title} slot="head" />
	<meta property="og:description" content={description} slot="head" />
	<meta property="og:url" content={canonicalUrl} slot="head" />
	<meta property="og:type" content="website" slot="head" />

	<main class="min-h-screen bg-gray-50">
		<!-- Hero Section -->
		<div
			class="bg-gradient-to-b from-primary-50/50 to-white border-b border-gray-100"
		>
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-20">
				<div class="text-center max-w-3xl mx-auto mb-8 lg:mb-12">
					<nav
						class="flex items-center justify-center space-x-2 text-sm text-gray-500 mb-6"
					>
						<a
							href="/"
							class="hover:text-primary-600 transition-colors"
							>Home</a
						>
						<span class="text-gray-300">/</span>
						<span class="font-medium text-gray-900">Countries</span>
					</nav>
					<h1
						class="text-3xl md:text-5xl lg:text-6xl font-bold text-gray-900 tracking-tight mb-4 lg:mb-6"
					>
						Airports by <span class="text-primary-600">Country</span
						>
					</h1>
					<p class="text-lg lg:text-xl text-gray-600 leading-relaxed">
						Explore airports by country and discover aviation
						infrastructure worldwide
					</p>
				</div>

				<!-- Stats Grid -->
				<div
					class="grid grid-cols-2 md:grid-cols-5 gap-3 lg:gap-6 max-w-5xl mx-auto"
				>
					<div
						class="bg-white p-4 lg:p-6 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition-shadow"
					>
						<div
							class="text-2xl lg:text-3xl font-bold text-primary-600 mb-1"
						>
							{stats.total.toLocaleString()}
						</div>
						<div
							class="text-xs lg:text-sm font-medium text-gray-500"
						>
							Total Airports
						</div>
					</div>
					<div
						class="bg-white p-4 lg:p-6 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition-shadow"
					>
						<div
							class="text-2xl lg:text-3xl font-bold text-green-600 mb-1"
						>
							{stats.large.toLocaleString()}
						</div>
						<div
							class="text-xs lg:text-sm font-medium text-gray-500"
						>
							Large Airports
						</div>
					</div>
					<div
						class="bg-white p-4 lg:p-6 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition-shadow"
					>
						<div
							class="text-2xl lg:text-3xl font-bold text-yellow-600 mb-1"
						>
							{stats.medium.toLocaleString()}
						</div>
						<div
							class="text-xs lg:text-sm font-medium text-gray-500"
						>
							Medium Airports
						</div>
					</div>
					<div
						class="bg-white p-4 lg:p-6 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition-shadow"
					>
						<div
							class="text-2xl lg:text-3xl font-bold text-purple-600 mb-1"
						>
							{stats.small.toLocaleString()}
						</div>
						<div
							class="text-xs lg:text-sm font-medium text-gray-500"
						>
							Small Airports
						</div>
					</div>
					<div
						class="bg-white p-4 lg:p-6 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition-shadow col-span-2 md:col-span-1"
					>
						<div
							class="text-2xl lg:text-3xl font-bold text-gray-700 mb-1"
						>
							{stats.countries.toLocaleString()}
						</div>
						<div
							class="text-xs lg:text-sm font-medium text-gray-500"
						>
							Countries
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Search and Filter Section -->
		<!-- <div
			class="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-gray-200 shadow-sm"
		>
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
				<div
					class="flex flex-col lg:flex-row gap-3 lg:gap-4 items-center justify-between"
				>
					<div class="flex-1 max-w-md w-full">
						<div class="relative">
							<div
								class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
							>
								<svg
									class="h-5 w-5 text-gray-400"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
									></path>
								</svg>
							</div>
							<input
								type="text"
								id="country-search"
								placeholder="Search countries..."
								class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-xl leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm transition-shadow"
							/>
						</div>
					</div>
					<div class="flex gap-3 w-full lg:w-auto">
						<select
							id="sort-select"
							class="flex-1 lg:flex-initial px-4 py-2.5 text-sm border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 rounded-xl"
						>
							<option value="name">Sort by Name</option>
							<option value="airports"
								>Sort by Airport Count</option
							>
						</select>
					</div>
				</div>
			</div>
		</div> -->

		<!-- Countries Grid -->
		<section class="py-8 lg:py-12">
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
				<div class="flex items-center justify-between mb-6 lg:mb-8">
					<h2 class="text-xl lg:text-2xl font-bold text-gray-900">
						Browse Countries & Territories
					</h2>
					<span
						class="px-3 py-1 lg:px-4 lg:py-1.5 bg-white border border-gray-200 rounded-full text-xs lg:text-sm font-medium text-gray-600 shadow-sm"
					>
						{countries.length} countries
					</span>
				</div>

				<div
					id="countries-grid"
					class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6"
				>
					{
						countries.map((country) => (
							<article
								class="relative group bg-white rounded-2xl shadow-sm border border-gray-200 p-4 lg:p-6 hover:shadow-xl hover:border-primary-100 transition-all duration-300 flex flex-col h-full country-card"
								data-country={country.country}
								data-country-name={
									country.country_name || country.country
								}
								data-airport-count={country.airport_count}
							>
								<div class="flex items-center justify-between mb-4">
									<div class="flex items-center gap-3">
										<span
											class="text-3xl country-flag"
											data-code={country.country}
										/>
										<div>
											<h3 class="text-lg font-bold text-gray-900 group-hover:text-primary-600 transition-colors">
												{country.country_name ||
													country.country}
											</h3>
											<span class="text-xs font-mono font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded">
												{country.country}
											</span>
										</div>
									</div>
								</div>

								<div class="mb-6 flex-grow">
									<div class="text-3xl font-bold text-primary-600 mb-1">
										{country.airport_count.toLocaleString()}
									</div>
									<div class="text-sm text-gray-500">
										Airport
										{country.airport_count !== 1 ? "s" : ""}
									</div>

									<div class="mt-4 grid grid-cols-2 gap-2 text-xs">
										<div class="bg-green-50 rounded-lg p-2">
											<div class="font-semibold text-green-700">
												{country.large_airport_count ||
													0}
											</div>
											<div class="text-green-600">
												Large
											</div>
										</div>
										<div class="bg-yellow-50 rounded-lg p-2">
											<div class="font-semibold text-yellow-700">
												{country.medium_airport_count ||
													0}
											</div>
											<div class="text-yellow-600">
												Medium
											</div>
										</div>
									</div>
								</div>

								<div class="mt-auto pt-4 border-t border-gray-100">
									<a
										href={`/countries/${country.country}`}
										class="block w-full text-center px-4 py-2 bg-primary-50 text-primary-700 text-sm font-medium rounded-xl hover:bg-primary-100 transition-colors group-hover:bg-primary-600 group-hover:text-white after:absolute after:inset-0"
									>
										View Airports
									</a>
								</div>
							</article>
						))
					}
				</div>
			</div>
		</section>
	</main>
</Layout>

<script>
	// Function to get country flag emoji
	function getCountryFlag(countryCode: string): string {
		if (!countryCode || countryCode.length !== 2) return "ðŸ³ï¸";

		// Convert country code to flag emoji
		const codePoints = countryCode
			.toUpperCase()
			.split("")
			.map((char) => 127397 + char.charCodeAt(0));

		return String.fromCodePoint(...codePoints);
	}

	// DOM elements
	const countrySearch = document.getElementById(
		"country-search",
	) as HTMLInputElement;
	const sortSelect = document.getElementById(
		"sort-select",
	) as HTMLSelectElement;

	// Get all country elements
	function getAllCountryCards(): HTMLElement[] {
		return Array.from(
			document.querySelectorAll(".country-card"),
		) as HTMLElement[];
	}

	// Sort countries
	function sortCountries() {
		const sortBy = sortSelect.value;
		const cards = getAllCountryCards();
		const grid = document.getElementById("countries-grid")!;

		const sortedCards = cards.sort((a, b) => {
			if (sortBy === "airports") {
				const countA = parseInt(a.dataset.airportCount || "0");
				const countB = parseInt(b.dataset.airportCount || "0");
				return countB - countA;
			} else {
				const nameA = a.dataset.countryName || "";
				const nameB = b.dataset.countryName || "";
				return nameA.localeCompare(nameB);
			}
		});

		// Re-append sorted elements
		sortedCards.forEach((card) => grid.appendChild(card));
	}

	// Filter countries
	function filterCountries() {
		const query = countrySearch.value.toLowerCase().trim();
		const cards = getAllCountryCards();

		cards.forEach((card) => {
			const countryName = (card.dataset.countryName || "").toLowerCase();
			const countryCode = (card.dataset.country || "").toLowerCase();
			const matches =
				!query ||
				countryName.includes(query) ||
				countryCode.includes(query);
			card.style.display = matches ? "flex" : "none";
		});
	}

	// Initialize country flags
	function initializeFlags() {
		const flagElements = document.querySelectorAll(".country-flag");
		flagElements.forEach((element) => {
			const countryCode = element.getAttribute("data-code");
			if (countryCode) {
				element.textContent = getCountryFlag(countryCode);
			}
		});
	}

	// Event listeners
	countrySearch.addEventListener("input", filterCountries);
	sortSelect.addEventListener("change", sortCountries);

	// Initialize
	document.addEventListener("DOMContentLoaded", () => {
		initializeFlags();
	});
</script>

<style>
	/* Smooth scrolling */
	html {
		scroll-behavior: smooth;
	}

	/* Custom scrollbar for webkit */
	::-webkit-scrollbar {
		width: 8px;
	}
	::-webkit-scrollbar-track {
		background: #f1f1f1;
	}
	::-webkit-scrollbar-thumb {
		background: #cbd5e1;
		border-radius: 4px;
	}
	::-webkit-scrollbar-thumb:hover {
		background: #94a3b8;
	}
</style>
