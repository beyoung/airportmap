---
/**
 * Interactive Map Component
 * Displays airports on a world map using MapLibre GL JS
 *
 * Props (optional):
 * - latitude, longitude: if provided, centers map to airport and switches to "detail" mode
 * - name, ident, municipality, iso_country: used for marker popup in detail mode
 * When props are not provided, behaves as homepage world map.
 */

export interface Props {
  latitude?: number;
  longitude?: number;
  name?: string;
  ident?: string;
  municipality?: string;
  iso_country?: string;
}

const { latitude, longitude, name, ident, municipality, iso_country } = Astro.props as Props;
---

<div
  id="map"
  class="w-full h-[600px] relative"
  data-latitude={latitude ?? ''}
  data-longitude={longitude ?? ''}
  data-name={name ?? ''}
  data-ident={ident ?? ''}
  data-municipality={municipality ?? ''}
  data-iso-country={iso_country ?? ''}
></div>
<div
    id="map-loading"
    class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[1000] text-center bg-white/90 p-8 rounded-lg shadow-lg"
>
    <div
        class="w-8 h-8 border-4 border-gray-300 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"
    >
    </div>
    <p>Loading map...</p>
</div>

<script>
    import maplibregl from "maplibre-gl";
    import type * as GeoJSON from "geojson";
   
    // Read optional props from dataset to decide mode
    const mapEl = document.getElementById("map") as HTMLElement | null;
     console.log(mapEl?.dataset);
    const latStr = mapEl?.dataset.latitude ?? '';
    const lonStr = mapEl?.dataset.longitude ?? '';
    const hasCoords = latStr !== '' && lonStr !== '' && !isNaN(parseFloat(latStr)) && !isNaN(parseFloat(lonStr));
    const detailCenter: [number, number] = hasCoords
        ? [parseFloat(lonStr), parseFloat(latStr)]
        : [-120.00, 20.00];
    const initialZoom = hasCoords ? 12 : 1;

    // Initialize map (detail vs homepage)
    const map = new maplibregl.Map({
        container: "map",
        style: {
            version: 8,
            glyphs: "https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key=48F3wFYg8K0uzswJ8cdr", // Add font support
            sources: {
                "raster-tiles": {
                    type: "raster",
                    tiles: [
                        "https://api.maptiler.com/maps/satellite/256/{z}/{x}/{y}.jpg?key=48F3wFYg8K0uzswJ8cdr",
                    ],
                    tileSize: 256,
                    attribution: "¬© OpenStreetMap contributors",
                },
            },
            layers: [
                {
                    id: "simple-tiles",
                    type: "raster",
                    source: "raster-tiles",
                    minzoom: 0,
                    maxzoom: 16,
                },
            ],
        },
        center: detailCenter,
        zoom: initialZoom,
        maxZoom: 16,
        minZoom: 1,
    });
    map.addControl(new maplibregl.NavigationControl());
    map.addControl(new maplibregl.GlobeControl());
    map.addControl(new maplibregl.FullscreenControl());
    map.addControl(new maplibregl.GeolocateControl());
    
    map.on("style.load", () => {
        // map.setProjection({
        //   type: "globe",
        // });
    });
    // Hide loading indicator when map loads
    map.on("load", () => {

        const attribCtrl = document.querySelector(".maplibregl-ctrl-attrib");
        if (attribCtrl) {
        attribCtrl.classList.add("maplibregl-ctrl-compact");
        attribCtrl.classList.remove("maplibregl-compact-show");
        }

        document.getElementById("map-loading")?.classList.add("hidden");
        // Refs for detail-mode popup/marker so we can close later on empty clicks
        let selectedPopupRef: maplibregl.Popup | null = null;
        let selectedMarkerRef: maplibregl.Marker | null = null;

        // If in detail mode, add a primary marker and popup
        // (content rendered via createAirportPopupContent for consistency)
        if (hasCoords && mapEl) {
            const p = {
                name: mapEl.dataset.name || mapEl.dataset.ident || "Selected Airport",
                ident: mapEl.dataset.ident || "",
                iso_country: mapEl.dataset.isoCountry || "",
                municipality: mapEl.dataset.municipality || "",
                // municipality is not used by createAirportPopupContent, so omit safely
            } as Record<string, any>;

            const localTypeColors = {
                large_airport: "#ef4444",
                medium_airport: "#f59e0b",
                small_airport: "#10b981",
                heliport: "#3b82f6",
                seaplane_base: "#8b5cf6",
                balloonport: "#6366f1",
                default: "#9ca3af",
            } as Record<string, string>;

            const selectedPopup = new maplibregl.Popup({
                offset: 12,
                closeButton: true,
                closeOnClick: false,
                className:
                    "max-w-80 [&_.maplibregl-popup-content]:p-0 [&_.maplibregl-popup-content]:rounded-xl [&_.maplibregl-popup-content]:shadow-xl [&_.maplibregl-popup-content]:backdrop-blur-sm [&_.maplibregl-popup-content]:border [&_.maplibregl-popup-content]:border-white/20 [&_.maplibregl-popup-content]:overflow-hidden [&_.maplibregl-popup-content]:w-72 [&_.maplibregl-popup-content]:max-w-72 [&_.maplibregl-popup-content]:min-w-72 [&_.maplibregl-popup-tip]:border-t-white/95 [&_.maplibregl-popup-tip]:border-b-white/95",
            })
                .setHTML(createAirportPopupContent(p, localTypeColors, false))
                .setLngLat(detailCenter)
                .addTo(map);

            // Keep a reference to close later when clicking or clearing selection
            selectedPopupRef = selectedPopup;

            // Apply selected ring highlight consistent with click logic
            const selectedSource = map.getSource("selected-airport") as maplibregl.GeoJSONSource | undefined;
            if (selectedSource) {
                const initialGeom: GeoJSON.Point = { type: "Point", coordinates: detailCenter };
                selectedSource.setData({
                    type: "FeatureCollection",
                    features: [
                        { type: "Feature", geometry: initialGeom, properties: { type: p?.type ?? "default" } },
                    ],
                });
            }
        }

        map.addSource("airports", {
            type: "vector",
            tiles: ["https://tiles.ayamap.com/airport/{z}/{x}/{y}.mvt"],
            attribution: "¬© ayamap",
            minzoom: 0,
            maxzoom: 4, // Keep consistent with PMTiles data maxzoom
            promoteId: "ident", // Use ident field as feature ID for feature-state
        });

        // Add airport points layer
        map.addLayer({
            id: "airports-points",
            type: "circle",
            source: "airports",
            "source-layer": "airports",
            paint: {
                "circle-color": [
                    "match",
                    ["get", "type"],
                    "large_airport",
                    "#ef4444",
                    "medium_airport",
                    "#f59e0b",
                    "small_airport",
                    "#10b981",
                    "heliport",
                    "#3b82f6",
                    "seaplane_base",
                    "#8b5cf6",
                    "balloonport",
                    "#6366f1",
                    "#9ca3af",
                ],
                "circle-radius": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    0,
                    [
                        "*",
                        0.5,
                        [
                            "match",
                            ["get", "type"],
                            "large_airport",
                            6,
                            "medium_airport",
                            4.0,
                            "small_airport",
                            2,
                            "heliport",
                            1.2,
                            "seaplane_base",
                            1.2,
                            "balloonport",
                            1.0,
                            1.0,
                        ],
                    ],
                    2,
                    [
                        "*",
                        0.6,
                        [
                            "match",
                            ["get", "type"],
                            "large_airport",
                            6,
                            "medium_airport",
                            4.0,
                            "small_airport",
                            2,
                            "heliport",
                            1.2,
                            "seaplane_base",
                            1.2,
                            "balloonport",
                            1.0,
                            1.0,
                        ],
                    ],
                    4,
                    [
                        "*",
                        0.8,
                        [
                            "match",
                            ["get", "type"],
                            "large_airport",
                            6,
                            "medium_airport",
                            4.0,
                            "small_airport",
                            2,
                            "heliport",
                            1.2,
                            "seaplane_base",
                            1.2,
                            "balloonport",
                            1.0,
                            1.0,
                        ],
                    ],
                    8,
                    [
                        "*",
                        1.2,
                        [
                            "match",
                            ["get", "type"],
                            "large_airport",
                            6,
                            "medium_airport",
                            4.0,
                            "small_airport",
                            2,
                            "heliport",
                            1.2,
                            "seaplane_base",
                            1.2,
                            "balloonport",
                            1.0,
                            1.0,
                        ],
                    ],
                    12,
                    [
                        "*",
                        1.6,
                        [
                            "match",
                            ["get", "type"],
                            "large_airport",
                            6,
                            "medium_airport",
                            4.0,
                            "small_airport",
                            2,
                            "heliport",
                            1.2,
                            "seaplane_base",
                            1.2,
                            "balloonport",
                            1.0,
                            1.0,
                        ],
                    ],
                ],
                "circle-stroke-width": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    0,
                    [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        2.5,
                        0.5,
                    ],
                    2,
                    [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        3.0,
                        0.6,
                    ],
                    4,
                    [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        3.5,
                        0.8,
                    ],
                    8,
                    [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        4.0,
                        1.2,
                    ],
                    12,
                    [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        4.5,
                        1.6,
                    ],
                ],
                "circle-stroke-color": "#ffffff",
                "circle-opacity": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    0,
                    0.85,
                    6,
                    0.92,
                    12,
                    1.0,
                ],
            },
            minzoom: 0,
            maxzoom: 16,
        });

        // Add airport labels layer
        map.addLayer({
            id: "airports-labels",
            type: "symbol",
            source: "airports",
            "source-layer": "airports",
            layout: {
                "text-field": [
                    "case",
                    ["has", "name"],
                    ["get", "name"], // Prefer using name field
                    ["has", "ident"],
                    ["get", "ident"], // Use ident if name is not available
                    "", // Empty if neither exists
                ],
                "text-font": ["Open Sans Regular", "Arial Unicode MS Regular"],
                "text-size": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    6,
                    [
                        "match",
                        ["get", "type"],
                        "large_airport",
                        14,
                        "medium_airport",
                        12,
                        "small_airport",
                        11,
                        "heliport",
                        10,
                        "seaplane_base",
                        10,
                        "balloonport",
                        10,
                        10,
                    ],
                    12,
                    [
                        "match",
                        ["get", "type"],
                        "large_airport",
                        18,
                        "medium_airport",
                        16,
                        "small_airport",
                        14,
                        "heliport",
                        13,
                        "seaplane_base",
                        13,
                        "balloonport",
                        13,
                        13,
                    ],
                ],
                "text-offset": [0, 1.5], // Text offset to avoid overlapping with circle
                "text-anchor": "top",
                "text-allow-overlap": false, // Avoid text overlapping
                "text-optional": true,
            },
            paint: {
                "text-color": "#ffffff",
                "text-halo-color": "#000000",
                "text-halo-width": 1.5,
                "text-opacity": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    8,
                    0.8, // Opacity 0.8 at zoom level 4
                    10,
                    1.0, // Fully opaque at zoom level 8 and above
                ],
            },
            minzoom: 6, // Start showing text from zoom level 3 to avoid crowding at low zoom
            maxzoom: 16, // Allow display at higher zoom levels
        });

        // Hover popup for airports
        type AirportType =
            | "large_airport"
            | "medium_airport"
            | "small_airport"
            | "heliport"
            | "seaplane_base"
            | "balloonport";

        function formatType(t: string | undefined): string {
            if (!t) return "Unknown";
            return String(t)
                .replace(/_/g, " ")
                .replace(/\b\w/g, (c) => c.toUpperCase());
        }

        const typeColors: Record<AirportType | "default", string> = {
            large_airport: "#ef4444", // red
            medium_airport: "#f59e0b", // amber
            small_airport: "#10b981", // green
            heliport: "#3b82f6", // blue
            seaplane_base: "#8b5cf6", // violet
            balloonport: "#6366f1", // indigo
            default: "#9ca3af", // gray
        };

        // In detail mode: enrich the initial popup using full airport data
        // so content matches the click popup (IATA/ICAO, region, elevation, type)
        if (hasCoords && mapEl && mapEl.dataset.ident) {
            const identCode = mapEl.dataset.ident;
            // Wait until style/layers are idle, then try to read vector tile properties first
            map.once("idle", async () => {
                let enrichedProps: Record<string, any> | null = null;
                try {
                    const features = map.querySourceFeatures("airports", {
                        sourceLayer: "airports",
                        filter: ["==", ["get", "ident"], identCode],
                    });
                    if (features && features.length > 0) {
                        enrichedProps = (features[0].properties || {}) as Record<string, any>;
                    }
                } catch (_) {
                    // ignore and fall back to API
                }

                // Fallback: fetch from API by code if vector tile didn't return the feature
                if (!enrichedProps) {
                    try {
                        const res = await fetch(`/api/airports/${encodeURIComponent(identCode)}`);
                        if (res.ok) {
                            const data = await res.json();
                            const a = (data && data.airport) || {};
                            enrichedProps = {
                                ident: a.ident,
                                name: a.name,
                                type: a.type,
                                iata_code: a.iata_code,
                                icao_code: a.icao_code,
                                iso_region: a.iso_region,
                                iso_country: a.iso_country,
                                elevation_ft: a.elevation_ft,
                            } as Record<string, any>;
                        }
                    } catch (_) {
                        // ignore network errors
                    }
                }

                // Update the initial selected popup and selected ring if we obtained details
                if (enrichedProps && selectedPopupRef) {
                    selectedPopupRef.setHTML(createAirportPopupContent(enrichedProps, typeColors, false));
                    const selectedSource = map.getSource("selected-airport") as maplibregl.GeoJSONSource | undefined;
                    if (selectedSource) {
                        selectedSource.setData({
                            type: "FeatureCollection",
                            features: [
                                {
                                    type: "Feature",
                                    geometry: { type: "Point", coordinates: detailCenter },
                                    properties: { type: enrichedProps.type },
                                },
                            ],
                        });
                    }
                }
            });
        }

        const hoverPopup = new maplibregl.Popup({
            closeButton: false,
            closeOnClick: false,
            offset: 12,
            className:
                "max-w-80 [&_.maplibregl-popup-content]:p-0 [&_.maplibregl-popup-content]:rounded-xl [&_.maplibregl-popup-content]:shadow-xl [&_.maplibregl-popup-content]:backdrop-blur-sm [&_.maplibregl-popup-content]:border [&_.maplibregl-popup-content]:border-white/20 [&_.maplibregl-popup-content]:overflow-hidden [&_.maplibregl-popup-content]:w-72 [&_.maplibregl-popup-content]:max-w-72 [&_.maplibregl-popup-content]:min-w-72 [&_.maplibregl-popup-tip]:border-t-white/95 [&_.maplibregl-popup-tip]:border-b-white/95",
        });

        let hoveredAirportId: string | number | null = null;
        let clickedAirportId: string | number | null = null;

        // Unified popup content generator with compact Tailwind styling
        function createAirportPopupContent(
            properties: any,
            typeColors: Record<string, string>,
            showActions: boolean = true,
        ) {
            const p = properties || {};
            const name = p?.name || p?.ident || "Unknown Airport";
            const typeLabel = formatType(p?.type as string | undefined);
            const typeKey: AirportType | "default" =
                (p?.type as AirportType) ?? "default";
            const badgeColor = typeColors[typeKey];

            // Get airport icon based on type
            const getAirportIcon = (type: string) => {
                switch (type) {
                    case "large_airport":
                        return "üõ´";
                    case "medium_airport":
                        return "‚úàÔ∏è";
                    case "small_airport":
                        return "üõ©Ô∏è";
                    case "heliport":
                        return "üöÅ";
                    case "seaplane_base":
                        return "üõ•Ô∏è";
                    case "balloonport":
                        return "üéà";
                    default:
                        return "‚úàÔ∏è";
                }
            };

            return `
        <div class="airport-card-modern bg-gradient-to-br from-white via-slate-50 to-slate-100 rounded-xl shadow-xl border border-white/20 backdrop-blur-sm overflow-hidden w-72"
             data-airport-type="${p?.type || "default"}"
             style="--type-color:${badgeColor}">

          <!-- Compact Header -->
          <div class="relative bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800 px-4 py-3">
            <!-- Decorative top border -->
            <div class="absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-current to-transparent opacity-60"
                 style="color: ${badgeColor}"></div>

            <div class="relative flex items-center gap-3">
              <!-- Compact Airport icon -->
              <div class="flex-shrink-0 text-2xl">
                ${getAirportIcon(p?.type)}
              </div>

              <!-- Title section -->
              <div class="flex-1 min-w-0">
                <!-- Airport name with word wrap -->
                <h3 class="text-lg font-bold text-white leading-tight tracking-tight break-words">
                  ${name}
                </h3>

                <!-- Compact Type badge -->
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold uppercase tracking-wide text-white mt-1"
                      style="background: ${badgeColor};">
                  ${typeLabel}
                </span>
              </div>
            </div>
          </div>

          <!-- Compact Card body -->
          <div class="p-4 space-y-3">
            <!-- Airport code -->
            <div class="flex items-center gap-3 p-3 bg-white/60 backdrop-blur-sm rounded-lg border border-white/40 hover:bg-white/70 transition-colors duration-200">
              <div class="flex-shrink-0 w-6 h-6 rounded-md bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-xs">
                üè∑Ô∏è
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-medium text-slate-500 uppercase tracking-wide">Code</div>
                <div class="text-sm font-bold text-slate-800">
                  ${p?.iata_code ? `IATA: ${p.iata_code}` : ""}
                  ${p?.iata_code && p?.icao_code ? " | " : ""}
                  ${p?.icao_code ? `ICAO: ${p.icao_code}` : ""}
                  ${!p?.iata_code && !p?.icao_code ? p?.ident || "N/A" : ""}
                </div>
              </div>
            </div>

            <!-- Location -->
            <div class="flex items-center gap-3 p-3 bg-white/60 backdrop-blur-sm rounded-lg border border-white/40 hover:bg-white/70 transition-colors duration-200">
              <div class="flex-shrink-0 w-6 h-6 rounded-md bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-xs">
                üìç
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-medium text-slate-500 uppercase tracking-wide">Location</div>
                <div class="text-sm font-bold text-slate-800 truncate">${p?.iso_region || "Unknown"}, ${p?.iso_country || "Unknown"}</div>
              </div>
            </div>

            <!-- Elevation (conditional) -->
            ${
                p?.elevation_ft
                    ? `
              <div class="flex items-center gap-3 p-3 bg-white/60 backdrop-blur-sm rounded-lg border border-white/40 hover:bg-white/70 transition-colors duration-200">
                <div class="flex-shrink-0 w-6 h-6 rounded-md bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-xs">
                  ‚õ∞Ô∏è
                </div>
                <div class="flex-1 min-w-0">
                  <div class="text-xs font-medium text-slate-500 uppercase tracking-wide">Elevation</div>
                  <div class="text-sm font-bold text-slate-800">${p.elevation_ft} ft</div>
                </div>
              </div>
            `
                    : ""
            }
          </div>

          ${
            showActions
                ? `
          <!-- Compact Action buttons -->
          <div class="px-4 pb-4 flex gap-2">
            <a href="/airports/${p?.ident}" target="_blank"
               class="flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg font-medium text-sm text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200"
               style="background: linear-gradient(135deg, ${badgeColor}, color-mix(in srgb, ${badgeColor} 85%, black));">
              <span class="text-sm">üëÅÔ∏è</span>
              <span>View Details</span>
            </a>

            ${
                p?.iso_country
                    ? `
              <a href="/countries/${String(p.iso_country).toLowerCase()}" target="_blank"
                 class="flex-shrink-0 inline-flex items-center justify-center gap-1 px-3 py-2 rounded-lg font-medium text-sm text-slate-700 bg-white/80 hover:bg-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 border border-slate-200/50">
                <span class="text-sm">üåç</span>
                <span>${p.iso_country}</span>
              </a>
            `
                    : ""
            }
          </div>
          `
                : ""
          }
        </div>
      `;
        }

        map.on("mouseenter", "airports-points", () => {
            map.getCanvas().style.cursor = "pointer";
        });

        map.on("mousemove", "airports-points", (e) => {
            if (e.features && e.features.length > 0) {
                const feature = e.features[0];
                const p = feature.properties as any;
                // Stable feature id used for hover/click comparison; falls back to ident
                const fid: string | number | null =
                    (feature.id as string | number | undefined) ??
                    (p?.ident as string | number | undefined) ??
                    null;

                // If a click popup exists, only remove it when hovering a different airport
                if (clickedAirportId != null && fid != null) {
                    if (clickedAirportId !== fid && clickPopup.isOpen()) {
                        clickPopup.remove();
                        clickedAirportId = null;
                        const selectedSource = map.getSource("selected-airport") as maplibregl.GeoJSONSource | undefined;
                        if (selectedSource) {
                            selectedSource.setData({ type: "FeatureCollection", features: [] });
                        }
                    } else {
                        // Hovering the same airport as the clicked one: keep click popup, skip hover
                        hoveredAirportId = fid;
                        return;
                    }
                }

                // If initial detail popup exists, remove it when hovering any airport
                if (selectedPopupRef) {
                    selectedPopupRef.remove();
                    selectedPopupRef = null;
                }

                // Show hover popup for the feature under cursor
                hoveredAirportId = fid;
                hoverPopup
                    .setLngLat(e.lngLat)
                    .setHTML(createAirportPopupContent(p, typeColors, !hasCoords))
                    .addTo(map);
            }
        });

        map.on("mouseleave", "airports-points", () => {
            map.getCanvas().style.cursor = "";
            hoveredAirportId = null;
            hoverPopup.remove();
        });

        // Sticky popup & selected highlight
        map.addSource("selected-airport", {
            type: "geojson",
            data: { type: "FeatureCollection", features: [] },
        });
        map.addLayer({
            id: "selected-airport-ring",
            type: "circle",
            source: "selected-airport",
            paint: {
                "circle-color": "rgba(255,255,255,0)",
                "circle-radius": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    6,
                    6,
                    10,
                    10,
                    14,
                    14,
                ],
                "circle-stroke-color": [
                    "match",
                    ["get", "type"],
                    "large_airport",
                    "#ef4444",
                    "medium_airport",
                    "#f59e0b",
                    "small_airport",
                    "#10b981",
                    "heliport",
                    "#3b82f6",
                    "seaplane_base",
                    "#8b5cf6",
                    "balloonport",
                    "#6366f1",
                    "#9ca3af",
                ],
                "circle-stroke-width": 2.5,
            },
        });

        const clickPopup = new maplibregl.Popup({
            closeButton: true,
            closeOnClick: false,
            offset: 14,
            className:
                "max-w-80 [&_.maplibregl-popup-content]:p-0 [&_.maplibregl-popup-content]:rounded-xl [&_.maplibregl-popup-content]:shadow-xl [&_.maplibregl-popup-content]:backdrop-blur-sm [&_.maplibregl-popup-content]:border [&_.maplibregl-popup-content]:border-white/20 [&_.maplibregl-popup-content]:overflow-hidden [&_.maplibregl-popup-content]:w-72 [&_.maplibregl-popup-content]:max-w-72 [&_.maplibregl-popup-content]:min-w-72 [&_.maplibregl-popup-tip]:border-t-white/95 [&_.maplibregl-popup-tip]:border-b-white/95",
        });

        map.on("click", "airports-points", (e) => {
            if (!e.features || e.features.length === 0) return;
            const f = e.features[0];
            const geometry = f.geometry as GeoJSON.Point;
            const coordinates = geometry.coordinates.slice() as [number, number];
            const p = (f.properties || {}) as Record<string, any>;
            const pid: string | number | null =
                (f.id as string | number | undefined) ??
                ((f.properties as any)?.ident as string | number | undefined) ??
                null;

            // Remove hover popup when clicking to avoid duplicate popups
            hoverPopup.remove();
            // Also close initial detail popup/marker if present to avoid double popups
            if (selectedPopupRef) { selectedPopupRef.remove(); selectedPopupRef = null; }
            if (selectedMarkerRef) { selectedMarkerRef.remove(); selectedMarkerRef = null; }

            const selectedSource = map.getSource("selected-airport") as maplibregl.GeoJSONSource | undefined;
            if (selectedSource) {
                selectedSource.setData({
                    type: "FeatureCollection",
                    features: [
                        {
                            type: "Feature",
                            geometry,
                            properties: { type: p?.type },
                        },
                    ],
                });
            }
            clickPopup
                .setLngLat(coordinates)
                .setHTML(createAirportPopupContent(p, typeColors, !hasCoords))
                .addTo(map);

            // Track clicked airport id for subsequent hover logic
            clickedAirportId = pid;
        });

        // Close any popups when clicking on empty map (no airport picked)
        map.on("click", (e) => {
            const features = map.queryRenderedFeatures(e.point, { layers: ["airports-points"] });
            if (!features || features.length === 0) {
                hoverPopup.remove();
                clickPopup.remove();
                clickedAirportId = null;
                if (selectedPopupRef) selectedPopupRef.remove();
                const selectedSource = map.getSource("selected-airport") as maplibregl.GeoJSONSource | undefined;
                if (selectedSource) {
                    selectedSource.setData({ type: "FeatureCollection", features: [] });
                }
            }
        });
    });

    // Export map instance for external use
    (window as any).airportMap = map;
</script>
